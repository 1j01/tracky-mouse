<html>

<head>
	<meta charset="UTF-8">
	<title>Head Tracker</title>

	<script type="module">
		// console.log("HELLO");

		window.facemesh = new Worker("./facemesh.worker.js");

		facemesh.load = function load(...args) {
			return new Promise((resolve, reject)=> {
				facemesh.addEventListener("message", (e)=> {
					// console.log('Message received from worker', e.data);
					if (e.data.type === "LOADED") {
						resolve({
							estimateFaces: (videoElement)=> {
								const canvas = document.createElement("canvas");
								const ctx = canvas.getContext('2d');
								canvas.width = videoElement.videoWidth;
								canvas.height = videoElement.videoHeight;
								ctx.drawImage(videoElement, 0, 0);
								const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
								facemesh.postMessage({type: "ESTIMATE_FACES", imageData});
								return new Promise((resolve, reject)=> {
									facemesh.addEventListener("message", (e)=> {
										if (e.data.type === "ESTIMATED_FACES") {
											resolve(e.data.predictions);
										}
									}, {once: true});
								});
							}
						});
					}
				}, {once: true});
				facemesh.postMessage({type: "LOAD"});
			});
		};
		facemesh.onmessage = (e)=> {
			// console.log('Message received from worker', e.data);
		};

		// console.log(facemesh);
	</script>

	<script src="lib/clmtrackr.js"></script>

	<script src="lib/jsfeat-min.js"></script>

	<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
	<h2>Point Tracking and Head Tracking (<a href="head-tracker.js">source</a>)</h2>
	<p>
		This is an experiment in implementing a head tracking system similar to <a href="https://eviacam.crea-si.com/">eViacam</a>,
		using <a href="https://en.wikipedia.org/wiki/Lucas%E2%80%93Kanade_method">Lucasâ€“Kanade optical flow</a> to track points for high accuracy,
		and face recognition as a coarse input for understanding of where to place tracking points.
	</p>
	<p>
		You can click to track details in the video, but tracking points should be added automatically if your face is detected (in green not yellow).
	</p>
	<div id="controls">
		<label>Horizontal Sensitivity <input type="range" min="0" max="100" value="25" id="sensitivity-x"></label>
		<label>Vertical Sensitivity <input type="range" min="0" max="100" value="50" id="sensitivity-y"></label>
		<!-- <label>Smoothing <input type="range" min="0" max="100" value="50" id="smoothing"></label> -->
		<label><input type="checkbox" checked id="mirror"> Mirror</label>
	</div>
	<script src="head-tracker.js" async></script>
</body>

</html>
